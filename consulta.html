<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Reclutamiento ‚Äì Consulta</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="styles.css">
<style>
  /* Extras m√≠nimos para esta pantalla */
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
  .toolbar .grow{flex:1}
  .searchbox{position:relative}
  .searchbox input{padding-left:30px}
  .searchbox .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.55}
  .table-wrap{overflow:auto;border-radius:12px;border:1px solid #e5e7eb;background:#fff;margin-top:10px}
  #tabla{margin:0}
  #tabla thead th{position:sticky;top:0;z-index:1;background:#f3f4f6}
  #tabla thead th.sortable{cursor:pointer;user-select:none}
  #tabla thead th.sortable::after{content:"‚Üï";margin-left:6px;opacity:.4;font-size:12px}
  #tabla thead th.sortable.asc::after{content:"‚Üë"}
  #tabla thead th.sortable.desc::after{content:"‚Üì"}
  .skeleton td{height:40px;background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:sk 1.3s infinite}
  @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .pagerbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:10px;flex-wrap:wrap}
  .pagerbar .right{display:flex;gap:10px;align-items:center}
  .muted{color:#6b7280;font-size:12.5px}

  /* Leyenda de estado de documentos */
  .legend{display:flex;align-items:center;gap:8px}
  .doc-flag{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle}
  .doc-flag.ok{background:#16a34a}
  .doc-flag.miss{background:#ef4444}

  /* Modal de documentos */
  .docs-modal-backdrop{position:fixed;inset:0;background:#0005;display:none;align-items:center;justify-content:center;z-index:100}
  .docs-modal{background:#fff;border-radius:14px;max-width:720px;width:92%;max-height:80vh;overflow:auto;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
  .docs-modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px}
  .doc-list{list-style:none;margin:0;padding:0}
  .doc-list li{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff;margin:8px 0}
  .doc-name{font-weight:600}
  .doc-missing{color:#7f1d1d;background:#fee2e2;border-radius:999px;padding:2px 8px;font-size:12px;justify-self:start}
  .doc-ok{color:#14532d;background:#dcfce7;border-radius:999px;padding:2px 8px;font-size:12px;justify-self:start}
  .doc-actions{display:flex;gap:8px}
  .btn-link{background:#e5e7eb;color:#111827;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;text-decoration:none;display:inline-block}
  .btn-link.primary{background:#2563eb;color:#fff}
  .btn-link.danger{background:#fee2e2;color:#7f1d1d}
</style>
</head>
<body>
<a class="skip-link" href="#main">Saltar al contenido</a>
<header class="topbar">
  <button id="menuBtn" class="menu-btn" aria-controls="sidebar" aria-expanded="false" aria-label="Men√∫">‚ò∞</button>
  <div class="logo-sm">RR.HH. Suite</div>
</header>

<aside id="sidebar" class="sidebar">
  <div class="logo">RR.HH. Suite</div>
  <nav class="nav" aria-label="Navegaci√≥n principal">
    <div class="caption">Reclutamiento</div>
    <a href="formularioweb.html">Formulario</a>
    <a href="consulta.html" class="active" aria-current="page">Consulta</a>
    <div class="caption">Operaci√≥n</div>
    <a href="empleados.html">Empleados</a>
    <a href="contratos.html">Contratos</a>
    <a href="nomina.html">N√≥mina</a>
    <div class="sep"></div>
    <div class="caption">Usuario / Configuraci√≥n</div>
    <a href="config.html">Par√°metros de Empresa</a>
  </nav>
</aside>

<div id="backdrop" class="menu-backdrop" tabindex="-1"></div>

<main id="main" class="main" tabindex="-1">
  <div class="card">
    <h1>Consulta de Candidatos</h1>
    <div id="msg" role="status" aria-live="polite"></div>

    <!-- Filtros -->
    <div class="filters">
      <div class="box" id="boxFecha">
        <div style="margin-bottom:8px">
          <label><input type="radio" name="modo" value="fecha" checked> Filtrar por Mes + A√±o</label>
        </div>
        <label for="filtroAno">A√±o</label>
        <select id="filtroAno">
          <option value="TODOS">TODOS</option>
          <option>2023</option><option>2024</option><option>2025</option>
        </select>
        <label for="filtroMes">Mes</label>
        <select id="filtroMes">
          <option value="TODOS">TODOS</option>
          <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
          <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
          <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
          <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
        </select>
        <label for="filtroEstado">Estado</label>
        <select id="filtroEstado">
          <option value="">(Todos)</option>
          <option value="EN_REVISION">En revisi√≥n</option>
          <option value="CANCELADO">Cancelado</option>
          <option value="APROBADO">Aprobado</option>
        </select>
      </div>

      <div class="box" id="boxGrupo">
        <div style="margin-bottom:8px">
          <label><input type="radio" name="modo" value="grupo"> Filtrar por Grupo (rango)</label>
        </div>
        <label for="grupoInicio">Desde</label>
        <input id="grupoInicio" type="number" min="1" style="width:110px" />
        <label for="grupoFin">Hasta</label>
        <input id="grupoFin" type="number" min="1" style="width:110px" />
        <div class="small">Si solo completas ‚ÄúDesde‚Äù, busca ese grupo exacto.</div>
      </div>
    </div>

    <!-- Barra de acciones -->
    <div class="toolbar">
      <div class="searchbox grow">
        <span class="icon">üîé</span>
        <input id="q" type="text" placeholder="Buscar por DNI o nombre‚Ä¶" aria-label="Buscar por DNI o nombre" />
      </div>
      <button id="btnConsultar">Buscar</button>
      <button id="btnLimpiar" class="secondary">Limpiar</button>
      <div class="legend muted" aria-hidden="true" title="Leyenda: verde=cargado, rojo=faltante">
        <span class="doc-flag ok"></span><span>cargado</span>
        <span class="doc-flag miss" style="margin-left:8px"></span><span>faltante</span>
      </div>
      <button id="btnExport" class="secondary" disabled>Exportar CSV</button>
    </div>

    <!-- Tabla -->
    <div class="table-wrap" role="region" aria-label="Resultados">
      <table id="tabla">
        <thead>
          <tr>
            <th class="sortable" data-key="id">ID</th>
            <th class="sortable" data-key="dni_numero">DNI</th>
            <th class="sortable" data-key="nombre_completo">Nombre</th>
            <th class="sortable" data-key="sede">Sede</th>
            <th>Turno</th>
            <th class="sortable" data-key="grupo">Grupo</th>
            <th class="sortable" data-key="estado">Estado</th>
            <th class="sortable" data-key="fecha">Fecha</th>

            <!-- Columnas simplificadas (solo estado) -->
            <th>DNI - Doc</th>
            <th>Curriculum ‚Äì CV</th>
            <th>Documentos</th>

            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    <div class="pagerbar">
      <div class="muted" id="resume">0 resultados</div>
      <div class="right">
        <label class="small">Filas por p√°gina
          <select id="pageSize">
            <option>10</option><option selected>25</option><option>50</option><option>100</option>
          </select>
        </label>
        <button class="secondary" id="prevPage">¬´ Anterior</button>
        <span class="small" id="pageInfo">1 / 1</span>
        <button class="secondary" id="nextPage">Siguiente ¬ª</button>
      </div>
    </div>

  </div>
</main>

<!-- Modal de documentos -->
<div id="docsBackdrop" class="docs-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="docsTitle">
  <div class="docs-modal">
    <header>
      <h3 id="docsTitle">Documentos</h3>
      <button class="secondary" id="docsClose">Cerrar</button>
    </header>
    <div id="docsMeta" class="small" style="margin-bottom:8px;color:#6b7280"></div>
    <ul class="doc-list" id="docsList"></ul>
  </div>
</div>

<!-- Input de archivo reutilizable para Subir/Reemplazar -->
<input id="docFileInput" type="file" style="display:none" />

<script>
/* ====== Config / Helpers ====== */
const API_BASE = "https://empleados-api-o6yy.onrender.com";
const API_CANDIDATOS = `${API_BASE}/api/candidatos`;

// Si en el futuro conectas endpoints directos de documentos, c√°mbialo a true.
const ENABLE_DIRECT_DOC_API = false;

const $ = (id)=>document.getElementById(id);
function showMsg(type, text){ const box=$('msg'); box.className=type==='ok'?'ok':'err'; box.textContent=text; box.style.display='block'; }
function clearMsg(){ const box=$('msg'); box.style.display='none'; box.textContent=''; box.className=''; }
function tagEstado(estado){
  if (estado === 'APROBADO') return `<span class="tag apr">Aprobado</span>`;
  if (estado === 'CANCELADO') return `<span class="tag can">Cancelado</span>`;
  return `<span class="tag rev">En revisi√≥n</span>`;
}

/* DNI robusto: soporta variantes de nombre de campo */
function getDniNumero(c){
  return c?.dni_numero ?? c?.dniNumero ?? c?.dni_num ?? c?.dniNumber ?? c?.dniNro ?? c?.dni_nro ?? '';
}

/* Icono de estado de documento (solo punto de color con tooltip) */
function docFlag(ok, label){
  const ttl = `${label}: ${ok ? 'cargado' : 'faltante'}`;
  return `<span class="doc-flag ${ok?'ok':'miss'}" title="${ttl}" aria-label="${ttl}"></span>`;
}

/* ====== Estado de UI / Resultados ====== */
let RAW = [];
let FILTERED = [];
let page = 1;
let pageSize = 25;
let sortKey = 'fecha';
let sortDir = 'desc';

/* ====== URL <-> Estado ====== */
function readURL(){
  const u = new URL(location.href);
  const get = (k,def='') => u.searchParams.get(k) ?? def;
  const modo = get('modo','fecha');
  document.querySelector(`input[name="modo"][value="${modo}"]`).checked = true;
  $('filtroAno').value = get('ano','TODOS');
  $('filtroMes').value = get('mes','TODOS');
  $('filtroEstado').value = get('estado','');
  $('grupoInicio').value = get('gini','');
  $('grupoFin').value = get('gfin','');
  $('q').value = get('q','');
  page = parseInt(get('p','1')) || 1;
  pageSize = parseInt(get('ps', localStorage.getItem('consulta:ps') || '25')) || 25;
  $('pageSize').value = String(pageSize);
  sortKey = get('sk','fecha');
  sortDir = get('sd','desc');
  applyModeDisable();
}
function writeURL(){
  const u = new URL(location.href);
  const modo = document.querySelector('input[name="modo"]:checked').value;
  const ano = $('filtroAno').value;
  const mes = $('filtroMes').value;
  const estado = $('filtroEstado').value;
  const gini = $('grupoInicio').value.trim();
  const gfin = $('grupoFin').value.trim();
  const q = $('q').value.trim();
  u.searchParams.set('modo', modo);
  u.searchParams.set('ano', ano);
  u.searchParams.set('mes', mes);
  u.searchParams.set('estado', estado);
  if(gini) u.searchParams.set('gini', gini); else u.searchParams.delete('gini');
  if(gfin) u.searchParams.set('gfin', gfin); else u.searchParams.delete('gfin');
  if(q) u.searchParams.set('q', q); else u.searchParams.delete('q');
  u.searchParams.set('p', String(page));
  u.searchParams.set('ps', String(pageSize));
  u.searchParams.set('sk', sortKey);
  u.searchParams.set('sd', sortDir);
  history.replaceState(null, '', u.toString());
}

/* ====== Filtros ====== */
function applyModeDisable(){
  const modo = document.querySelector('input[name="modo"]:checked').value;
  const byFecha = (modo === 'fecha');
  ['filtroAno','filtroMes','filtroEstado'].forEach(id=>{ $(id).disabled = !byFecha; });
  ['grupoInicio','grupoFin'].forEach(id=>{ $(id).disabled = byFecha; });
}

/* ====== Fetch ====== */
function renderSkeleton(){
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = '';
  for(let i=0;i<6;i++){
    const tr = document.createElement('tr');
    tr.className = 'skeleton';
    tr.innerHTML = '<td colspan="12"></td>';
    tbody.appendChild(tr);
  }
}
async function consultar(){
  clearMsg();
  applyModeDisable();
  writeURL();

  const modo = document.querySelector('input[name="modo"]:checked').value;
  const estado = $('filtroEstado').value;
  let url = new URL(API_CANDIDATOS);

  if(modo === "fecha"){
    const ano = $('filtroAno').value;
    const mes = $('filtroMes').value;
    if (mes !== "TODOS" && ano === "TODOS"){
      showMsg('err', "Si seleccionas un mes espec√≠fico, el a√±o no puede ser TODOS.");
      return;
    }
    if (ano !== "TODOS") url.searchParams.set("ano", ano);
    if (mes !== "TODOS") url.searchParams.set("mes", mes);
  } else {
    const ini = $('grupoInicio').value.trim();
    const fin = $('grupoFin').value.trim();
    if (ini && !fin) { url.searchParams.set("grupoInicio", ini); url.searchParams.set("grupoFin", ini); }
    if (ini && fin)  { url.searchParams.set("grupoInicio", ini); url.searchParams.set("grupoFin", fin); }
  }
  if (estado) url.searchParams.set("estado", estado);

  renderSkeleton();
  const btn = $('btnConsultar'); const old = btn.textContent;
  btn.disabled = true; btn.textContent = 'Consultando‚Ä¶';

  try{
    const res = await fetch(url.toString());
    if(!res.ok){
      const clone=res.clone(); let detalle="";
      try{ const d=await clone.json(); detalle=d?.error||JSON.stringify(d) }catch{ try{ detalle=await clone.text(); }catch{} }
      throw new Error(`HTTP ${res.status} ‚Äì ${detalle||'Error'}`);
    }
    RAW = await res.json();
    page = 1;
    applySearchSortPaginate();
    if (RAW.length === 0) showMsg('ok','Sin resultados con los filtros seleccionados.');
    $('btnExport').disabled = RAW.length === 0;
  }catch(e){
    console.error(e);
    showMsg('err', `Error al consultar: ${e.message}`);
    renderTabla([]);
  } finally {
    btn.disabled = false; btn.textContent = old;
  }
}

/* ====== Buscar + Orden + Paginaci√≥n ====== */
function applySearchSortPaginate(){
  const terms = $('q').value.trim().toLowerCase().split(/\s+/).filter(Boolean);
  FILTERED = RAW.filter(r=>{
    if(!terms.length) return true;
    const hay = (String(getDniNumero(r)||'') + ' ' + String(r.nombre_completo||'')).toLowerCase();
    return terms.every(t => hay.includes(t));
  });

  FILTERED.sort((a,b)=>{
    let va = a[sortKey]; let vb = b[sortKey];
    if (sortKey === 'fecha') { va = (a.fecha || a.created_at || a.createdAt || ''); vb = (b.fecha || b.created_at || b.createdAt || ''); }
    if(typeof va === 'string') va = va.toLowerCase();
    if(typeof vb === 'string') vb = vb.toLowerCase();
    if(va < vb) return sortDir==='asc' ? -1 : 1;
    if(va > vb) return sortDir==='asc' ? 1 : -1;
    return 0;
  });

  const total = FILTERED.length;
  const maxPage = Math.max(1, Math.ceil(total / pageSize));
  if(page > maxPage) page = maxPage;

  const start = (page-1)*pageSize;
  const pageItems = FILTERED.slice(start, start+pageSize);

  renderTabla(pageItems);
  $('resume').textContent = `${total} resultado${total!==1?'s':''}`;
  $('pageInfo').textContent = `${page} / ${maxPage}`;

  document.querySelectorAll('#tabla thead th.sortable').forEach(th=>{
    th.classList.remove('asc','desc');
    th.removeAttribute('aria-sort');
    if (th.dataset.key === sortKey) {
      th.classList.add(sortDir);
      th.setAttribute('aria-sort', sortDir === 'asc' ? 'ascending' : 'descending');
    }
  });
}

/* ====== Tabla (con columnas de estado) ====== */
function renderTabla(lista){
  const tbody = document.querySelector('#tabla tbody');
  tbody.innerHTML = "";
  if(!lista || lista.length===0){
    tbody.innerHTML = `
      <tr><td colspan="12" style="padding:16px;text-align:center;color:#6b7280">
        No se encontraron registros con los filtros actuales.<br/>
        <button class="secondary" id="vaciarFiltros" style="margin-top:8px">Limpiar filtros</button>
      </td></tr>`;
    $('vaciarFiltros')?.addEventListener('click', ()=> $('btnLimpiar').click());
    return;
  }
  for(const c of lista){
    const fechaNorm = (c.fecha || c.created_at || c.createdAt || '').slice(0,10);

    // Solo iconos de estado; todo lo dem√°s via modal
    const dniDocIcon = docFlag(!!c.dni, 'DNI - Doc');
    const cvIcon     = docFlag(!!c.cv,  'Curriculum ‚Äì CV');
    const docsBtn    = `<button class="btn-link primary" onclick="openDocsModal(${c.id})">Documentos</button>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${getDniNumero(c)}</td>
      <td>${c.nombre_completo||''}</td>
      <td>${c.sede || ''}</td>
      <td>${c.turno_horario || ''}</td>
      <td>${c.grupo || ''}</td>
      <td>${tagEstado(c.estado)}</td>
      <td>${fechaNorm}</td>

      <!-- columnas de estado -->
      <td style="text-align:center">${dniDocIcon}</td>
      <td style="text-align:center">${cvIcon}</td>
      <td>${docsBtn}</td>

      <td>
        ${c.estado !== 'APROBADO'
          ? `<button onclick="aprobar(${c.id})" style="margin-bottom:6px">Aprobar</button><br/>` : ``}
        <a href="formularioweb.html?id=${c.id}">Editar</a>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

/* ====== Modal de Documentos ====== */
let CURRENT_CANDIDATE = null;
function docItemsFromCandidate(c){
  return [
    { key:'dni',          label:'DNI',                 url:c?.dni||'',           accept:'.pdf,.jpg,.jpeg,.png' },
    { key:'certificados', label:'Certificados',       url:c?.certificados||'',  accept:'.pdf,.jpg,.jpeg,.png' },
    { key:'antecedentes', label:'Antecedentes',       url:c?.antecedentes||'',  accept:'.pdf,.jpg,.jpeg,.png' },
    { key:'medicos',      label:'Documentos M√©dicos', url:c?.medicos||'',       accept:'.pdf,.jpg,.jpeg,.png' },
    { key:'capacitacion', label:'Capacitaci√≥n',       url:c?.capacitacion||'',  accept:'.pdf,.jpg,.jpeg,.png' },
    { key:'cv',           label:'Curriculum ‚Äì CV',    url:c?.cv||'',            accept:'.pdf,.doc,.docx' }
  ];
}

window.openDocsModal = function(id){
  const cand = RAW.find(x=>String(x.id)===String(id)) || FILTERED.find(x=>String(x.id)===String(id));
  if(!cand){ showMsg('err','No se encontr√≥ el candidato'); return; }
  CURRENT_CANDIDATE = cand;

  const bd   = $('docsBackdrop');
  const meta = $('docsMeta');
  const ul   = $('docsList');
  const title= $('docsTitle');

  title.textContent = `Documentos ‚Äì ID ${cand.id}`;
  meta.textContent  = cand.nombre_completo || '';
  ul.innerHTML = '';

  const items = docItemsFromCandidate(cand);
  for(const it of items){
    const has = !!it.url;
    const li = document.createElement('li');
    li.innerHTML = `
      <span class="doc-name">${it.label}</span>
      ${has ? '<span class="doc-ok">Disponible</span>' : '<span class="doc-missing">No cargado</span>'}
      <div class="doc-actions">
        ${has ? `<a class="btn-link" href="${it.url}" target="_blank" rel="noopener">Abrir</a>` : ''}
        <button class="btn-link primary" data-key="${it.key}" data-accept="${it.accept}">
          ${has ? 'Reemplazar‚Ä¶' : 'Subir‚Ä¶'}
        </button>
        <button class="btn-link danger" ${ENABLE_DIRECT_DOC_API ? '' : 'disabled title="Desactivado para no romper la API"'}
                data-del="${it.key}">Eliminar</button>
      </div>
    `;
    ul.appendChild(li);
  }

  bd.style.display = 'flex';
};

$('docsClose').addEventListener('click', ()=> $('docsBackdrop').style.display='none');
$('docsBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='docsBackdrop') e.currentTarget.style.display='none'; });

/* Click en Subir‚Ä¶ / Reemplazar‚Ä¶ -> abrir file picker */
document.getElementById('docsList').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-key]');
  if(!btn) return;
  const key = btn.getAttribute('data-key');
  const accept = btn.getAttribute('data-accept') || '*/*';
  const fileInput = $('docFileInput');
  fileInput.value = '';
  fileInput.setAttribute('accept', accept);
  fileInput.dataset.key = key;
  fileInput.dataset.candidateId = CURRENT_CANDIDATE?.id || '';
  fileInput.click();
});

$('docFileInput').addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  const key = e.target.dataset.key;
  const id  = e.target.dataset.candidateId;
  try{
    await uploadDocument(id, key, file);
    showMsg('ok','Archivo listo para subir (demo). Conecta el endpoint para completar.');
  }catch(err){
    showMsg('err', err.message || 'Error al subir');
  }finally{
    $('docsBackdrop').style.display='none';
    consultar();
  }
});

/* Stubs de subida/borrado (no rompen nada) */
async function uploadDocument(id, key, file){
  if(!ENABLE_DIRECT_DOC_API){
    return Promise.resolve();
  }
  const fd = new FormData();
  fd.append(key, file);
  const res = await fetch(`${API_CANDIDATOS}/${id}/documentos/${key}`, { method:'POST', body: fd });
  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    throw new Error(`Error HTTP ${res.status} ${txt}`);
  }
}
async function deleteDoc(id, key){
  if(!ENABLE_DIRECT_DOC_API) return;
  if(!confirm('¬øEliminar este documento?')) return;
  const res = await fetch(`${API_CANDIDATOS}/${id}/documentos/${key}`, { method:'DELETE' });
  if(!res.ok){
    const txt = await res.text().catch(()=> '');
    showMsg('err', `No se pudo eliminar (${res.status}) ${txt}`);
  }else{
    showMsg('ok','Documento eliminado');
    $('docsBackdrop').style.display='none';
    consultar();
  }
}

/* ====== Eventos UI ====== */
document.querySelectorAll('.nav a').forEach(a=>{
  const href=a.getAttribute('href');
  if (href && location.pathname.endsWith(href)){
    a.classList.add('active'); a.setAttribute('aria-current','page');
  }
});
document.querySelectorAll('input[name="modo"]').forEach(r=>
  r.addEventListener('change', applyModeDisable)
);

// Atajo "/" para enfocar b√∫squeda
document.addEventListener('keydown',(e)=>{
  if (e.key === '/' && !e.target.closest('input,select,textarea,button')) {
    e.preventDefault(); $('q').focus();
  }
});

$('btnConsultar').addEventListener('click', consultar);
$('btnLimpiar').addEventListener('click', ()=>{
  $('filtroAno').value = "TODOS";
  $('filtroMes').value = "TODOS";
  $('filtroEstado').value = "";
  $('grupoInicio').value = "";
  $('grupoFin').value = "";
  document.querySelector("input[name='modo'][value='fecha']").checked = true;
  $('q').value = '';
  page = 1;
  clearMsg();
  writeURL();
  renderTabla([]);
  $('resume').textContent = '0 resultados';
  $('pageInfo').textContent = '1 / 1';
  $('btnExport').disabled = true;
});

// Debounce b√∫squeda
let t = null;
$('q').addEventListener('input', ()=>{
  clearTimeout(t);
  t = setTimeout(()=>{ page=1; applySearchSortPaginate(); writeURL(); }, 250);
});

// Orden por columnas
document.querySelectorAll('#tabla thead th.sortable').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.key;
    if(sortKey === key){ sortDir = (sortDir==='asc'?'desc':'asc'); }
    else { sortKey = key; sortDir = (key==='fecha'?'desc':'asc'); }
    page = 1;
    applySearchSortPaginate();
    writeURL();
  });
});

// Paginaci√≥n
$('pageSize').addEventListener('change', ()=>{
  pageSize = parseInt($('pageSize').value) || 25;
  localStorage.setItem('consulta:ps', String(pageSize));
  page = 1;
  applySearchSortPaginate();
  writeURL();
});
$('prevPage').addEventListener('click', ()=>{
  if(page>1){ page--; applySearchSortPaginate(); writeURL(); }
});
$('nextPage').addEventListener('click', ()=>{
  const maxPage = Math.max(1, Math.ceil(FILTERED.length / pageSize));
  if(page<maxPage){ page++; applySearchSortPaginate(); writeURL(); }
});

// Export CSV (ahora exporta estados SI/NO)
$('btnExport').addEventListener('click', ()=>{
  const rows = [
    ['ID','DNI (n√∫mero)','Nombre','Sede','Turno','Grupo','Estado','Fecha','dni_doc_ok','cv_ok','docs_resumen']
  ];
  FILTERED.forEach(c=>{
    const fecha = (c.fecha || c.created_at || c.createdAt || '').slice(0,10);
    const resumen = [
      c.certificados?'certificados':'',
      c.antecedentes?'antecedentes':'',
      c.medicos?'medicos':'',
      c.capacitacion?'capacitacion':''
    ].filter(Boolean).join('; ');
    rows.push([
      c.id, getDniNumero(c), c.nombre_completo||'', c.sede||'', c.turno_horario||'',
      c.grupo||'', c.estado||'', fecha,
      c.dni ? 'SI':'NO',
      c.cv ? 'SI':'NO',
      resumen
    ]);
  });
  const csv = rows.map(r=>r.map(v=>{
    const s = String(v).replaceAll('"','""');
    return `"${s}"`;
  }).join(',')).join('\n');
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'candidatos.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
});

/* Aprobar */
async function aprobar(id){
  if(!confirm("¬øMarcar candidato como APROBADO?")) return;
  try{
    const res = await fetch(`${API_CANDIDATOS}/${id}/estado`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ estado: "APROBADO" })
    });
    if(!res.ok){
      const clone=res.clone(); let detalle="";
      try{ const d=await clone.json(); detalle=d?.error||JSON.stringify(d) }catch{ try{ detalle=await clone.text(); }catch{} }
      throw new Error(`HTTP ${res.status} ‚Äì ${detalle||'Error'}`);
    }
    showMsg('ok', 'Candidato aprobado.');
    await consultar();
  }catch(e){
    console.error(e);
    showMsg('err', `Error al aprobar: ${e.message}`);
  }
}

/* Men√∫ m√≥vil + init */
function closeMenu(){ document.body.classList.remove('menu-open'); $('menuBtn').setAttribute('aria-expanded','false'); }
document.addEventListener('DOMContentLoaded', ()=>{
  const btn=$('menuBtn'); const backdrop=$('backdrop');
  btn?.addEventListener('click',()=>{ const open=document.body.classList.toggle('menu-open'); btn.setAttribute('aria-expanded',open); });
  backdrop?.addEventListener('click',closeMenu);
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeMenu(); });

  readURL();
  applySearchSortPaginate();
  consultar();
});
</script>
</body>
</html>
















