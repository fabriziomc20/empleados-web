<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Reclutamiento ‚Äì Consulta</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="styles.css">
</head>
<body>
<a class="skip-link" href="#main">Saltar al contenido</a>
<header class="topbar">
  <button id="menuBtn" class="menu-btn" aria-controls="sidebar" aria-expanded="false" aria-label="Men√∫">‚ò∞</button>
  <div class="logo-sm">RR.HH. Suite</div>
</header>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <div class="logo">RR.HH. Suite</div>
  <nav class="nav" aria-label="Navegaci√≥n principal">
    <div style="font-size:12px;opacity:.7;margin:8px 0">Reclutamiento</div>
    <a href="formularioweb.html">Formulario</a>
    <a href="consulta.html" class="active">Consulta</a>
    <div style="font-size:12px;opacity:.7;margin:12px 0 6px">Operaci√≥n</div>
    <a href="empleados.html">Empleados</a>
    <a href="contratos.html">Contratos</a>
    <a href="nomina.html">N√≥mina</a>
    <div class="sep"></div>
    <div class="caption">Usuario / Configuraci√≥n</div>
    <a href="config.html">Par√°metros de Empresa</a>
  </nav>
</aside>

<div id="backdrop" class="menu-backdrop" tabindex="-1"></div>

<main id="main" class="main" tabindex="-1">
  <div class="card">
    <h1>Consulta de Candidatos</h1>

    <div id="msg"></div>

    <div class="filters">
      <div class="box">
        <div style="margin-bottom:8px">
          <label><input type="radio" name="modo" value="fecha" checked> Filtrar por Mes + A√±o</label>
        </div>
        <label>A√±o</label>
        <select id="filtroAno">
          <option value="TODOS">TODOS</option>
          <option>2023</option><option>2024</option><option>2025</option>
        </select>
        <label>Mes</label>
        <select id="filtroMes">
          <option value="TODOS">TODOS</option>
          <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
          <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
          <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
          <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
        </select>
        <span style="display:inline-block;margin-left:10px"></span>
        <label>Estado</label>
        <select id="filtroEstado">
          <option value="">(Todos)</option>
          <option value="EN_REVISION">En revisi√≥n</option>
          <option value="CANCELADO">Cancelado</option>
          <option value="APROBADO">Aprobado</option>
        </select>
      </div>

      <div class="box">
        <div style="margin-bottom:8px">
          <label><input type="radio" name="modo" value="grupo"> Filtrar por Grupo (rango)</label>
        </div>
        <label>Desde</label>
        <input id="grupoInicio" type="number" min="1" style="width:110px" />
        <label>Hasta</label>
        <input id="grupoFin" type="number" min="1" style="width:110px" />
        <div style="font-size:12px;color:#9CA3AF;margin-top:6px">
          Ej.: 49‚Äì52 (si solo ‚ÄúDesde‚Äù, filtra ese grupo exacto).
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <button id="btnConsultar">Consultar</button>
      <button id="btnLimpiar" class="secondary">Limpiar</button>
    </div>

    <table id="tabla">
      <thead>
        <tr>
          <th>ID</th>
          <th>DNI</th>
          <th>Nombre</th>
          <th>Sede</th>
          <th>Turno</th>
          <th>Grupo</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>DNI Doc</th>
          <th>Certif.</th>
          <th>Anteced.</th>
          <th>M√©dicos</th>
          <th>Capacit.</th>
          <th>CV</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>
</main>

<script>
const API_BASE = "https://empleados-api-o6yy.onrender.com"; // <-- CAMBIA ESTO
const API_CANDIDATOS = `${API_BASE}/api/candidatos`;

function showMsg(type, text){
  const box = document.getElementById('msg');
  box.className = type==='ok'?'ok':'err';
  box.textContent = text;
  box.style.display = 'block';
}
function clearMsg(){ const box = document.getElementById('msg'); box.style.display='none'; box.textContent=''; box.className=''; }

document.querySelectorAll('.nav a').forEach(a=>{
  const href=a.getAttribute('href');
  if (href && location.pathname.endsWith(href)){
    a.classList.add('active');
    a.setAttribute('aria-current','page');
  }
});

document.getElementById("btnConsultar").addEventListener("click", consultar);
document.getElementById("btnLimpiar").addEventListener("click", ()=>{
  document.getElementById("filtroAno").value = "TODOS";
  document.getElementById("filtroMes").value = "TODOS";
  document.getElementById("filtroEstado").value = "";
  document.getElementById("grupoInicio").value = "";
  document.getElementById("grupoFin").value = "";
  document.querySelector("input[name='modo'][value='fecha']").checked = true;
  clearMsg();
  renderTabla([]);
});

async function consultar(){
  clearMsg();
  const modo = document.querySelector("input[name='modo']:checked").value;
  const estado = document.getElementById("filtroEstado").value;

  let url = new URL(API_CANDIDATOS);

  if(modo === "fecha"){
    const ano = document.getElementById("filtroAno").value;
    const mes = document.getElementById("filtroMes").value;
    if (mes !== "TODOS" && ano === "TODOS"){
      showMsg('err', "Si seleccionas un mes espec√≠fico, el a√±o no puede ser TODOS.");
      return;
    }
    url.searchParams.set("ano", ano);
    url.searchParams.set("mes", mes);
  } else {
    const ini = document.getElementById("grupoInicio").value.trim();
    const fin = document.getElementById("grupoFin").value.trim();
    if (ini && !fin) { url.searchParams.set("grupoInicio", ini); url.searchParams.set("grupoFin", ini); }
    if (ini && fin)  { url.searchParams.set("grupoInicio", ini); url.searchParams.set("grupoFin", fin); }
  }
  if (estado) url.searchParams.set("estado", estado);

  try{
    const res = await fetch(url.toString());
    if(!res.ok){
      const clone=res.clone(); let detalle="";
      try{ const d=await clone.json(); detalle=d?.error||JSON.stringify(d) }catch{ try{ detalle=await clone.text(); }catch{} }
      throw new Error(`HTTP ${res.status} ‚Äì ${detalle||'Error'}`);
    }
    const data = await res.json();
    renderTabla(data);
    if (data.length === 0) showMsg('ok','Sin resultados con los filtros seleccionados.');
  }catch(e){
    console.error(e);
    showMsg('err', `Error al consultar: ${e.message}`);
  }
}

function tagEstado(estado){
  if (estado === 'APROBADO') return `<span class="tag apr">Aprobado</span>`;
  if (estado === 'CANCELADO') return `<span class="tag can">Cancelado</span>`;
  return `<span class="tag rev">En revisi√≥n</span>`;
}

function linkDoc(url, id){
  return url ? `<a href="${url}" target="_blank">üìé Descargar</a>`
             : `<a href="formularioweb.html?id=${id}">‚¨ÜÔ∏è Subir</a>`;
}

function renderTabla(lista){
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML = "";
  if(!lista || lista.length===0){
    tbody.innerHTML = `<tr><td colspan="15">No se encontraron registros</td></tr>`;
    return;
  }
  for(const c of lista){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.dni}</td>
      <td>${c.nombre_completo}</td>
      <td>${c.sede || ''}</td>
      <td>${c.turno_horario || ''}</td>
      <td>${c.grupo || ''}</td>
      <td>${tagEstado(c.estado)}</td>
      <td>${(c.fecha||'').slice(0,10)}</td>
      <td>${linkDoc(c.dni, c.id)}</td>
      <td>${linkDoc(c.certificados, c.id)}</td>
      <td>${linkDoc(c.antecedentes, c.id)}</td>
      <td>${linkDoc(c.medicos, c.id)}</td>
      <td>${linkDoc(c.capacitacion, c.id)}</td>
      <td>${linkDoc(c.cv, c.id)}</td>
      <td>
        ${c.estado !== 'APROBADO' ? `<button onclick="aprobar(${c.id})" style="margin-bottom:6px">Aprobar</button><br/>` : ``}
        <a href="formularioweb.html?id=${c.id}">Editar</a>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

async function aprobar(id){
  if(!confirm("¬øMarcar candidato como APROBADO?")) return;
  try{
    const res = await fetch(`${API_CANDIDATOS}/${id}/estado`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ estado: "APROBADO" })
    });
    if(!res.ok){
      const clone=res.clone(); let detalle="";
      try{ const d=await clone.json(); detalle=d?.error||JSON.stringify(d) }catch{ try{ detalle=await clone.text(); }catch{} }
      throw new Error(`HTTP ${res.status} ‚Äì ${detalle||'Error'}`);
    }
    showMsg('ok', 'Candidato aprobado.');
    consultar(); // recarga la tabla
  }catch(e){
    console.error(e);
    showMsg('err', `Error al aprobar: ${e.message}`);
  }
}

// primera carga
consultar();
</script>
<script>
function closeMenu(){
  document.body.classList.remove('menu-open');
  document.getElementById('menuBtn').setAttribute('aria-expanded','false');
}
document.addEventListener('DOMContentLoaded',()=>{
  const btn=document.getElementById('menuBtn');
  const backdrop=document.getElementById('backdrop');
  btn?.addEventListener('click',()=>{
    const open=document.body.classList.toggle('menu-open');
    btn.setAttribute('aria-expanded',open);
  });
  backdrop?.addEventListener('click',closeMenu);
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeMenu(); });
});
</script>
</body>
</html>






