<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Usuario / Configuración</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--brand:#2563eb;}
  *{box-sizing:border-box}
  body{margin:0;display:flex;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  .sidebar{width:260px;background:#0b1220;min-height:100vh;padding:18px;position:sticky;top:0}
  .logo{font-weight:700;margin-bottom:14px}
  .nav a{display:block;padding:10px 12px;border-radius:10px;color:var(--text);text-decoration:none;margin:6px 0}
  .nav a.active{background:var(--brand)}
  .nav a:hover{background:#1f2937}
  .sep{height:1px;background:#1f2937;margin:12px 0}
  .caption{font-size:12px;opacity:.7;margin:8px 0}
  .main{flex:1;padding:20px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px}
  .card{background:var(--panel);border-radius:14px;padding:16px}
  h2{margin:6px 0 12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  button{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#374151}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #374151;padding:8px;text-align:center;font-size:14px}
  th{background:#1f2937}
  a{color:#60a5fa;text-decoration:none}
  #msg{display:none;margin-bottom:12px;padding:10px;border-radius:10px}
  .ok{background:#065f46;color:#ecfdf5}
  .err{background:#7f1d1d;color:#fee2e2}
  .small{font-size:12px;color:#9ca3af}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal{background:#111827;border-radius:14px;max-width:900px;width:90%;max-height:80vh;overflow:auto;padding:16px}
  .modal header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:10px}
  .modal input[type="search"]{width:260px;padding:8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">RR.HH. Suite</div>
  <nav class="nav">
    <div class="caption">Reclutamiento</div>
    <a href="formularioweb.html">Formulario</a>
    <a href="consulta.html">Consulta</a>
    <div class="caption">Operación</div>
    <a href="empleados.html">Empleados</a>
    <a href="contratos.html">Contratos</a>
    <a href="nomina.html">Nómina</a>
    <div class="sep"></div>
    <div class="caption">Usuario / Configuración</div>
    <a href="config.html" class="active">Parámetros de Empresa</a>
  </nav>
</aside>

<main class="main">
  <div id="msg"></div>
  <div class="grid">

    <!-- EMPRESA -->
    <div class="card">
      <h2>Empresa</h2>
      <div class="row">
        <div><label>RUC</label><input id="empRuc" placeholder="20123456789"></div>
        <div><label>Razón Social</label><input id="empName" placeholder="Mi Empresa SAC"></div>
      </div>
      <label>Logo URL (opcional)</label>
      <input id="empLogo" placeholder="https://...">
      <div class="actions">
        <button id="btnEmpGuardar">Guardar/Actualizar</button>
        <button class="secondary" id="btnEmpCargar">Cargar existente</button>
      </div>
      <div class="small">Solo manejaremos 1 empresa activa (la principal).</div>
    </div>

    <!-- RÉGIMEN TRIBUTARIO -->
    <div class="card">
      <h2>Régimen Tributario</h2>
      <div class="row">
        <div>
          <label>Régimen</label>
          <select id="taxRegime"></select>
        </div>
        <div>
          <label>Vigente desde</label>
          <input id="taxValidFrom" type="date">
        </div>
      </div>
      <div class="actions">
        <button id="btnTaxSave">Guardar/Actualizar Régimen</button>
        <button class="secondary" id="btnTaxReload">Recargar</button>
        <button class="secondary" id="btnTaxHistory">Ver historial</button>
      </div>
      <div class="small" id="taxCurrent"></div>
    </div>

    <!-- SEDES -->
    <div class="card">
      <h2>Sedes</h2>
      <div class="row">
        <div><label>Nombre de la Sede</label><input id="siteName" placeholder="Sede Lima"></div>
      </div>
      <div class="actions">
        <button id="btnSiteAdd">Agregar</button>
        <button class="secondary" id="btnSitesView">Ver todo</button>
      </div>
    </div>

    <!-- PROYECTOS (sin sede) -->
    <div class="card">
      <h2>Proyectos</h2>
      <div class="row">
        <div><label>Nombre del Proyecto</label><input id="projName" placeholder="Proyecto General Lima"></div>
      </div>
      <div class="small">El código interno se genera automáticamente.</div>
      <div class="actions">
        <button id="btnProjAdd">Agregar</button>
        <button class="secondary" id="btnProjectsView">Ver todo</button>
      </div>
    </div>

    <!-- TURNOS -->
    <div class="card">
      <h2>Turnos</h2>
      <div class="row3">
        <div><label>Nombre</label><input id="shiftName" placeholder="Mañana"></div>
        <div><label>Inicio</label><input id="shiftStart" type="time" value="08:00"></div>
        <div><label>Fin</label><input id="shiftEnd" type="time" value="17:00"></div>
      </div>
      <div class="actions">
        <button id="btnShiftAdd">Agregar</button>
        <button class="secondary" id="btnShiftsView">Ver todo</button>
      </div>
    </div>

  </div>
</main>

<!-- MODAL reutilizable -->
<div id="modalWrap" class="modal-backdrop">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Listado</h3>
      <div>
        <input id="modalSearch" type="search" placeholder="Buscar…">
        <button class="secondary" onclick="closeModal()">Cerrar</button>
      </div>
    </header>
    <div id="modalContent"></div>
    <div class="pager">
      <button class="secondary" id="modalPrev">« Prev</button>
      <span id="modalPageInfo" class="small"></span>
      <button class="secondary" id="modalNext">Next »</button>
    </div>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const API_BASE = "https://empleados-api-o6yy.onrender.com"; // ⚠️ ajusta si es distinto
const EMP = `${API_BASE}/api/employer`;
const TAX_REGIMES = `${API_BASE}/api/regimes/tax`;
const EMP_TAX = `${API_BASE}/api/employer/tax`;
const EMP_TAX_HISTORY = `${API_BASE}/api/employer/tax/history`;
const SITES = `${API_BASE}/api/sites`;
const PROJECTS = `${API_BASE}/api/projects`;
const SHIFTS = `${API_BASE}/api/shifts`;

/* ========== UI helpers ========== */
function showMsg(type, text){ const box=document.getElementById('msg'); box.className=type==='ok'?'ok':'err'; box.textContent=text; box.style.display='block'; }
function clearMsg(){ const box=document.getElementById('msg'); box.style.display='none'; box.textContent=''; box.className=''; }

/* destacar link activo */
document.querySelectorAll('.nav a').forEach(a=>{
  if (a.getAttribute('href') && location.pathname.endsWith(a.getAttribute('href'))) a.classList.add('active');
});

/* ========== Empresa ========== */
btnEmpCargar.addEventListener('click', loadEmployer);
btnEmpGuardar.addEventListener('click', saveEmployer);

async function loadEmployer(){
  clearMsg();
  try{
    const res = await fetch(EMP);
    if(!res.ok) throw new Error(`${res.status}`);
    const data = await res.json();
    if(!data){ showMsg('ok','No hay empresa registrada aún.'); return; }
    empRuc.value = data.ruc||''; empName.value=data.name||''; empLogo.value=data.logo_url||'';
    showMsg('ok','Empresa cargada.');
  }catch(e){ showMsg('err',`Error al cargar empresa: ${e.message}`); }
}
async function saveEmployer(){
  clearMsg();
  try{
    const body = { ruc: empRuc.value.trim(), name: empName.value.trim(), logo_url: empLogo.value.trim()||null };
    const res = await fetch(EMP, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
    showMsg('ok','Empresa guardada/actualizada.');
  }catch(e){ showMsg('err',`Error al guardar empresa: ${e.message}`); }
}

/* ========== Régimen Tributario ========== */
btnTaxReload.addEventListener('click', initTaxBlock);
btnTaxSave.addEventListener('click', saveEmployerTax);
document.getElementById('btnTaxHistory').addEventListener('click', openTaxHistoryModal);

async function loadTaxRegimes(){
  const res = await fetch(TAX_REGIMES);
  const data = res.ok ? await res.json() : [];
  taxRegime.innerHTML = data.map(r => `<option value="${r.code}">${r.name}</option>`).join('');
}
async function loadCurrentTax(){
  const res = await fetch(EMP_TAX);
  if(!res.ok) return;
  const cur = await res.json();
  taxCurrent.textContent = cur ? `Actual: ${cur.name} (desde ${cur.valid_from})` : 'Sin régimen vigente.';
  if(cur){ taxRegime.value = cur.code; }
}
async function loadTaxHistory(){
  const res = await fetch(EMP_TAX_HISTORY);
  return res.ok ? await res.json() : [];
}
async function saveEmployerTax(){
  clearMsg();
  try{
    const body = {
      regime_code: taxRegime.value,
      valid_from: taxValidFrom.value || new Date().toISOString().slice(0,10)
    };
    const res = await fetch(EMP_TAX, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
    showMsg('ok', 'Régimen actualizado.');
    await loadCurrentTax();
  }catch(e){ showMsg('err', `Error al actualizar régimen: ${e.message}`); }
}
async function initTaxBlock(){
  taxValidFrom.value = new Date().toISOString().slice(0,10);
  await loadTaxRegimes();
  await loadCurrentTax();
}
async function openTaxHistoryModal(){
  const data = await loadTaxHistory();
  openModal("Histórico de Régimen Tributario", data, [
    { header:"ID", field:"id" },
    { header:"Régimen", field:"name" },
    { header:"Desde", field:"valid_from" },
    { header:"Hasta", field:"valid_to" },
  ], "tax");
}

/* ========== Sedes (sin código manual) ========== */
btnSiteAdd.addEventListener('click', async ()=>{
  clearMsg();
  try{
    const body = { name: siteName.value.trim() };
    const res = await fetch(SITES, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
    siteName.value='';
    showMsg('ok','Sede creada.');
    await reloadSites();
  }catch(e){ showMsg('err',`Error al crear sede: ${e.message}`); }
});

/* ========== Proyectos (sin sede) ========== */
btnProjAdd.addEventListener('click', async ()=>{
  clearMsg();
  try{
    const body = { name: projName.value.trim() };
    if(!body.name) throw new Error("Completa el nombre del proyecto");

    const res = await fetch(PROJECTS, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });

    if(!res.ok){
      const t = await res.text();
      throw new Error(`${res.status} ${t}`);
    }

    projName.value='';
    showMsg('ok','Proyecto creado.');
    await reloadProjects();
  }catch(e){
    showMsg('err',`Error al crear proyecto: ${e.message}`);
  }
});

/* ========== Turnos ========== */
btnShiftAdd.addEventListener('click', async ()=>{
  clearMsg();
  try{
    const body = { name: shiftName.value.trim(), start_time: shiftStart.value, end_time: shiftEnd.value };
    const res = await fetch(SHIFTS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
    shiftName.value='';
    showMsg('ok','Turno creado.');
    await reloadShifts();
  }catch(e){ showMsg('err',`Error al crear turno: ${e.message}`); }
});

/* ========== Carga de listas mínimas ========== */
async function reloadSites(){
  try{
    const res = await fetch(SITES); if(!res.ok) throw new Error(`${res.status}`);
    const data = await res.json();
    window._sitesCached = data || [];
  }catch(e){ showMsg('err',`Error al listar sedes: ${e.message}`); }
}
async function reloadProjects(){
  try{ const r = await fetch(PROJECTS); window._projectsCached = r.ok? await r.json() : []; }catch{}
}
async function reloadShifts(){
  try{ const r = await fetch(SHIFTS); window._shiftsCached = r.ok? await r.json() : []; }catch{}
}

/* ========== Modal genérico ========== */
let modalState = { items:[], page:1, perPage:10, kind:"", columns:[] };

function openModal(title, items, columns, kind){
  modalState = { items, page:1, perPage:10, kind, columns };
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalSearch').value = "";
  renderModal();
  document.getElementById('modalWrap').style.display = "flex";
}
function closeModal(){ document.getElementById('modalWrap').style.display = "none"; }

function renderModal(){
  const q = document.getElementById('modalSearch').value.trim().toLowerCase();
  const filtered = modalState.items.filter(it => JSON.stringify(it).toLowerCase().includes(q));
  const total = filtered.length;
  const maxPage = Math.max(1, Math.ceil(total / modalState.perPage));
  if (modalState.page > maxPage) modalState.page = maxPage;

  const start = (modalState.page - 1) * modalState.perPage;
  const pageItems = filtered.slice(start, start + modalState.perPage);

  const tbl = document.createElement('table');
  tbl.innerHTML = `
    <thead><tr>${modalState.columns.map(c=>`<th>${c.header}</th>`).join("")}<th>Acciones</th></tr></thead>
    <tbody>
      ${pageItems.map(it => `
        <tr>
          ${modalState.columns.map(c=>`<td>${it[c.field] ?? ""}</td>`).join("")}
          <td>
            <button onclick="modalEdit('${modalState.kind}', ${it.id})">Editar</button>
            <button class="secondary" onclick="modalDelete('${modalState.kind}', ${it.id})">Eliminar</button>
          </td>
        </tr>`).join("")}
    </tbody>`;
  const content = document.getElementById('modalContent');
  content.innerHTML = "";
  content.appendChild(tbl);

  document.getElementById('modalPageInfo').textContent = `Página ${modalState.page} / ${maxPage} — ${total} registros`;
  document.getElementById('modalPrev').onclick = () => { if(modalState.page>1){ modalState.page--; renderModal(); } };
  document.getElementById('modalNext').onclick = () => { if(modalState.page<maxPage){ modalState.page++; renderModal(); } };
}
document.getElementById('modalSearch').addEventListener('input', renderModal);

async function modalEdit(kind, id){
  if(kind==="sites"){
    const row = (window._sitesCached||[]).find(x=>x.id===id);
    const nuevo = prompt("Nuevo nombre de sede:", row?.name || "");
    if(nuevo===null) return;
    const res = await fetch(`${SITES}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: nuevo }) });
    if(res.ok){ await reloadSites(); await openSitesModal(); }
  }else if(kind==="projects"){
    const row = (window._projectsCached||[]).find(x=>x.id===id);
    const nuevo = prompt("Nuevo nombre de proyecto:", row?.name || "");
    if(nuevo===null) return;
    const payload = { name: nuevo };
    const res = await fetch(`${PROJECTS}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok){ await reloadProjects(); await openProjectsModal(); }
  }else if(kind==="shifts"){
    const row = (window._shiftsCached||[]).find(x=>x.id===id);
    const nuevo = prompt("Nuevo nombre del turno:", row?.name || "");
    if(nuevo===null) return;
    const res = await fetch(`${SHIFTS}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: nuevo }) });
    if(res.ok){ await reloadShifts(); await openShiftsModal(); }
  }
}
async function modalDelete(kind, id){
  if(!confirm("¿Eliminar?")) return;
  let url="";
  if(kind==="sites") url=`${SITES}/${id}`;
  if(kind==="projects") url=`${PROJECTS}/${id}`;
  if(kind==="shifts") url=`${SHIFTS}/${id}`;
  const r = await fetch(url, { method:'DELETE' });
  if(!r.ok){ alert("No se pudo eliminar (puede estar referenciado)."); return; }
  if(kind==="sites"){ await reloadSites(); await openSitesModal(); }
  if(kind==="projects"){ await reloadProjects(); await openProjectsModal(); }
  if(kind==="shifts"){ await reloadShifts(); await openShiftsModal(); }
}

/* Botones Ver todo */
async function openSitesModal(){
  const res = await fetch(SITES); const data = res.ok ? await res.json() : [];
  window._sitesCached = data;
  openModal("Sedes", data, [
    { header:"ID", field:"id" },
    { header:"Código", field:"code" },
    { header:"Nombre", field:"name" },
  ], "sites");
}
async function openProjectsModal(){
  const res = await fetch(PROJECTS); const data = res.ok ? await res.json() : [];
  window._projectsCached = data;
  openModal("Proyectos", data, [
    { header:"ID", field:"id" },
    { header:"Código", field:"code" },
    { header:"Nombre", field:"name" },
  ], "projects");
}
async function openShiftsModal(){
  const res = await fetch(SHIFTS); const data = res.ok ? await res.json() : [];
  window._shiftsCached = data;
  openModal("Turnos", data, [
    { header:"ID", field:"id" },
    { header:"Nombre", field:"name" },
    { header:"Inicio", field:"start_time" },
    { header:"Fin", field:"end_time" },
  ], "shifts");
}
document.getElementById('btnSitesView').addEventListener('click', openSitesModal);
document.getElementById('btnProjectsView').addEventListener('click', openProjectsModal);
document.getElementById('btnShiftsView').addEventListener('click', openShiftsModal);

/* ========== init ========== */
(async function init(){
  clearMsg();
  try{ await loadEmployer(); }catch{}
  await initTaxBlock();
  await reloadSites();
  await reloadProjects();
  await reloadShifts();
})();
</script>
</body>
</html>



