<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Usuario / Configuración</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="styles.css">
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
<a class="skip-link" href="#main">Saltar al contenido</a>
<header class="topbar">
  <button id="menuBtn" class="menu-btn" aria-controls="sidebar" aria-expanded="false" aria-label="Menú">☰</button>
  <div class="logo-sm">RR.HH. Suite</div>
</header>

<aside id="sidebar" class="sidebar">
  <div class="logo">RR.HH. Suite</div>
  <nav class="nav" aria-label="Navegación principal">
    <div class="caption">Reclutamiento</div>
    <a href="formularioweb.html">Formulario</a>
    <a href="consulta.html">Consulta</a>
    <div class="caption">Operación</div>
    <a href="empleados.html">Empleados</a>
    <a href="contratos.html">Contratos</a>
    <a href="nomina.html">Nómina</a>
    <div class="sep"></div>
    <div class="caption">Usuario / Configuración</div>
    <a href="config.html" class="active">Parámetros de Empresa</a>
  </nav>
</aside>

<div id="backdrop" class="menu-backdrop" tabindex="-1"></div>

<main id="main" class="main" tabindex="-1">
  <div id="msg"></div>
  <div class="grid">

    <!-- EMPRESA -->
    <div class="card">
      <h2>Empresa</h2>
      <div class="row">
        <div><label>RUC</label><input id="empRuc" placeholder="20123456789"></div>
        <div><label>Razón Social</label><input id="empName" placeholder="Mi Empresa SAC"></div>
      </div>
      <label>Logo URL (opcional)</label>
      <input id="empLogo" placeholder="https://...">
      <div class="actions">
        <button id="btnEmpGuardar">Guardar/Actualizar</button>
        <button class="secondary" id="btnEmpCargar">Cargar existente</button>
      </div>
      <div class="small">Solo manejaremos 1 empresa activa (la principal).</div>
    </div>

    <!-- RÉGIMEN TRIBUTARIO -->
    <div class="card">
      <h2>Régimen Tributario</h2>
      <div class="row">
        <div>
          <label>Régimen</label>
          <select id="taxRegime"></select>
        </div>
        <div>
          <label>Vigente desde</label>
          <input id="taxValidFrom" type="date">
        </div>
      </div>
      <div class="actions">
        <button id="btnTaxSave">Guardar/Actualizar Régimen</button>
        <button class="secondary" id="btnTaxReload">Recargar</button>
        <button class="secondary" id="btnTaxHistory">Ver historial</button>
      </div>
      <div class="small" id="taxCurrent"></div>
    </div>

    <!-- SEDES -->
    <div class="card" x-data="{open:false}">
      <h2>Sedes</h2>
      <div class="row">
        <div><label>Nombre de la Sede</label><input id="siteName" placeholder="Sede Lima"></div>
      </div>
      <div class="actions">
        <button id="btnSiteAdd">Agregar</button>
        <button class="secondary" hx-get="partials/sites-list.html" hx-target="#sitesModalBody" @click="open=true">Ver todo</button>
      </div>

      <div x-cloak x-bind:class="open ? 'modal-backdrop open' : 'modal-backdrop'" @click.self="open=false">
        <div class="modal">
          <header>
            <h3>Listado de Sedes</h3>
            <button @click="open=false" aria-label="Cerrar">✖</button>
          </header>
          <div id="sitesModalBody">Cargando…</div>
        </div>
      </div>
    </div>

    <!-- PROYECTOS (sin sede) -->
    <div class="card">
      <h2>Proyectos</h2>
      <div class="row">
        <div><label>Nombre del Proyecto</label><input id="projName" placeholder="Proyecto General Lima"></div>
      </div>
      <div class="small">El código interno se genera automáticamente.</div>
      <div class="actions">
        <button id="btnProjAdd">Agregar</button>
        <button class="secondary" id="btnProjectsView">Ver todo</button>
      </div>
    </div>

    <!-- TURNOS -->
    <div class="card">
      <h2>Turnos</h2>
      <div class="row3">
        <div><label>Nombre</label><input id="shiftName" placeholder="Mañana"></div>
        <div><label>Inicio</label><input id="shiftStart" type="time" value="08:00"></div>
        <div><label>Fin</label><input id="shiftEnd" type="time" value="17:00"></div>
      </div>
      <div class="actions">
        <button id="btnShiftAdd">Agregar</button>
        <button class="secondary" id="btnShiftsView">Ver todo</button>
      </div>
    </div>

  </div>
</main>

<!-- MODAL reutilizable -->
<div id="modalWrap" class="modal-backdrop">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Listado</h3>
      <div>
        <input id="modalSearch" type="search" placeholder="Buscar…">
        <button class="secondary" onclick="closeModal()">Cerrar</button>
      </div>
    </header>
    <div id="modalContent"></div>
    <div class="pager">
      <button class="secondary" id="modalPrev">« Prev</button>
      <span id="modalPageInfo" class="small"></span>
      <button class="secondary" id="modalNext">Next »</button>
    </div>
  </div>
</div>

<script>
// ===== Helpers UI =====
function showMsg(type, text){
  const box = document.getElementById('msg');
  if(!box) return;
  box.className = type === 'ok' ? 'ok' : 'err';
  box.textContent = text;
  box.style.display = 'block';
}
function clearMsg(){
  const box = document.getElementById('msg');
  if(!box) return;
  box.style.display = 'none';
  box.textContent = '';
  box.className = '';
}
// Mostrar errores JS arriba
window.addEventListener('error', (e)=>{ showMsg('err', `JS Error: ${e.message}`); });

// ===== CONFIG API =====
const API_BASE = "https://empleados-api-o6yy.onrender.com";
const EMP = `${API_BASE}/api/employer`;
const TAX_REGIMES = `${API_BASE}/api/regimes/tax`;
const EMP_TAX = `${API_BASE}/api/employer/tax`;
const EMP_TAX_HISTORY = `${API_BASE}/api/employer/tax/history`;
const SITES = `${API_BASE}/api/sites`;
const PROJECTS = `${API_BASE}/api/projects`;
const SHIFTS = `${API_BASE}/api/shifts`;

// ===== Data funcs =====
async function loadEmployer(){
  clearMsg();
  const res = await fetch(EMP);
  if(!res.ok) throw new Error(`${res.status}`);
  const data = await res.json();
  const empRuc = document.getElementById('empRuc');
  const empName = document.getElementById('empName');
  const empLogo = document.getElementById('empLogo');
  if(!data){ showMsg('ok','No hay empresa registrada aún.'); return; }
  if(empRuc) empRuc.value = data.ruc || '';
  if(empName) empName.value = data.name || '';
  if(empLogo) empLogo.value = data.logo_url || '';
  showMsg('ok','Empresa cargada.');
}
async function saveEmployer(){
  clearMsg();
  const empRuc = document.getElementById('empRuc');
  const empName = document.getElementById('empName');
  const empLogo = document.getElementById('empLogo');
  const body = {
    ruc: empRuc?.value.trim(),
    name: empName?.value.trim(),
    logo_url: (empLogo?.value.trim() || null)
  };
  const res = await fetch(EMP, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
  showMsg('ok','Empresa guardada/actualizada.');
}

async function loadTaxRegimes(){
  const res = await fetch(TAX_REGIMES);
  const data = res.ok ? await res.json() : [];
  const taxRegime = document.getElementById('taxRegime');
  if(taxRegime) taxRegime.innerHTML = data.map(r => `<option value="${r.code}">${r.name}</option>`).join('');
}
async function loadCurrentTax(){
  const res = await fetch(EMP_TAX);
  if(!res.ok) return;
  const cur = await res.json();
  const taxCurrent = document.getElementById('taxCurrent');
  const taxRegime = document.getElementById('taxRegime');
  if(taxCurrent) taxCurrent.textContent = cur ? `Actual: ${cur.name} (desde ${cur.valid_from})` : 'Sin régimen vigente.';
  if(cur && taxRegime){ taxRegime.value = cur.code; }
}
async function loadTaxHistory(){
  const res = await fetch(EMP_TAX_HISTORY);
  return res.ok ? await res.json() : [];
}
async function saveEmployerTax(){
  clearMsg();
  const taxRegime = document.getElementById('taxRegime');
  const taxValidFrom = document.getElementById('taxValidFrom');
  const body = {
    regime_code: taxRegime?.value,
    valid_from: (taxValidFrom?.value || new Date().toISOString().slice(0,10))
  };
  const res = await fetch(EMP_TAX, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
  showMsg('ok', 'Régimen actualizado.');
  await loadCurrentTax();
}

// ===== List reloads =====
async function reloadSites(){ const r=await fetch(SITES); if(!r.ok) throw new Error(`${r.status}`); window._sitesCached=await r.json(); }
async function reloadProjects(){ try{ const r=await fetch(PROJECTS); window._projectsCached=r.ok?await r.json():[] }catch{} }
async function reloadShifts(){ try{ const r=await fetch(SHIFTS); window._shiftsCached=r.ok?await r.json():[] }catch{} }

// ===== Modal genérico =====
let modalState = { items:[], page:1, perPage:10, kind:"", columns:[] };
function openModal(title, items, columns, kind){
  modalState = { items, page:1, perPage:10, kind, columns };
  const titleEl = document.getElementById('modalTitle');
  const searchEl = document.getElementById('modalSearch');
  const wrap = document.getElementById('modalWrap');
  if(titleEl) titleEl.textContent = title;
  if(searchEl) searchEl.value = "";
  renderModal();
  if(wrap) wrap.style.display = "flex";
}
function closeModal(){ const wrap=document.getElementById('modalWrap'); if(wrap) wrap.style.display="none"; }
window.closeModal = closeModal;

function renderModal(){
  const searchEl = document.getElementById('modalSearch');
  const q = (searchEl?.value || "").trim().toLowerCase();
  const filtered = modalState.items.filter(it => JSON.stringify(it).toLowerCase().includes(q));
  const total = filtered.length;
  const maxPage = Math.max(1, Math.ceil(total / modalState.perPage));
  if (modalState.page > maxPage) modalState.page = maxPage;

  const start = (modalState.page - 1) * modalState.perPage;
  const pageItems = filtered.slice(start, start + modalState.perPage);

  const tbl = document.createElement('table');
  tbl.innerHTML = `
    <thead><tr>${modalState.columns.map(c=>`<th>${c.header}</th>`).join("")}<th>Acciones</th></tr></thead>
    <tbody>
      ${pageItems.map(it => `
        <tr>
          ${modalState.columns.map(c=>`<td>${it[c.field] ?? ""}</td>`).join("")}
          <td>
            <button onclick="modalEdit('${modalState.kind}', ${it.id})">Editar</button>
            <button class="secondary" onclick="modalDelete('${modalState.kind}', ${it.id})">Eliminar</button>
          </td>
        </tr>`).join("")}
    </tbody>`;
  const content = document.getElementById('modalContent');
  if(content){ content.innerHTML = ""; content.appendChild(tbl); }

  const info = document.getElementById('modalPageInfo');
  if(info) info.textContent = `Página ${modalState.page} / ${maxPage} — ${total} registros`;

  const prev = document.getElementById('modalPrev');
  const next = document.getElementById('modalNext');
  if(prev) prev.onclick = () => { if(modalState.page>1){ modalState.page--; renderModal(); } };
  if(next) next.onclick = () => { if(modalState.page<maxPage){ modalState.page++; renderModal(); } };
}
document.addEventListener('input', (ev)=>{
  if(ev.target && ev.target.id === 'modalSearch') renderModal();
});

async function modalEdit(kind, id){
  if(kind==="sites"){
    const row = (window._sitesCached||[]).find(x=>x.id===id);
    const nuevo = prompt("Nuevo nombre de sede:", row?.name || "");
    if(nuevo===null) return;
    const res = await fetch(`${SITES}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: nuevo }) });
    if(res.ok){ await reloadSites(); await openSitesModal(); }
  }else if(kind==="projects"){
    const row = (window._projectsCached||[]).find(x=>x.id===id);
    const nuevo = prompt("Nuevo nombre de proyecto:", row?.name || "");
    if(nuevo===null) return;
    const payload = { name: nuevo };
    const res = await fetch(`${PROJECTS}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(res.ok){ await reloadProjects(); await openProjectsModal(); }
  }else if(kind==="shifts"){
    const row = (window._shiftsCached||[]).find(x=>x.id===id);
    const nuevo = prompt("Nuevo nombre del turno:", row?.name || "");
    if(nuevo===null) return;
    const res = await fetch(`${SHIFTS}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: nuevo }) });
    if(res.ok){ await reloadShifts(); await openShiftsModal(); }
  }
}
window.modalEdit = modalEdit;

async function modalDelete(kind, id){
  if(!confirm("¿Eliminar?")) return;
  let url="";
  if(kind==="sites") url=`${SITES}/${id}`;
  if(kind==="projects") url=`${PROJECTS}/${id}`;
  if(kind==="shifts") url=`${SHIFTS}/${id}`;
  const r = await fetch(url, { method:'DELETE' });
  if(!r.ok){ alert("No se pudo eliminar (puede estar referenciado)."); return; }
  if(kind==="sites"){ await reloadSites(); await openSitesModal(); }
  if(kind==="projects"){ await reloadProjects(); await openProjectsModal(); }
  if(kind==="shifts"){ await reloadShifts(); await openShiftsModal(); }
}
window.modalDelete = modalDelete;

async function openSitesModal(){
  const res = await fetch(SITES); const data = res.ok ? await res.json() : [];
  window._sitesCached = data;
  openModal("Sedes", data, [
    { header:"ID", field:"id" },
    { header:"Código", field:"code" },
    { header:"Nombre", field:"name" },
  ], "sites");
}
async function openProjectsModal(){
  const res = await fetch(PROJECTS); const data = res.ok ? await res.json() : [];
  window._projectsCached = data;
  openModal("Proyectos", data, [
    { header:"ID", field:"id" },
    { header:"Código", field:"code" },
    { header:"Nombre", field:"name" },
  ], "projects");
}
async function openShiftsModal(){
  const res = await fetch(SHIFTS); const data = res.ok ? await res.json() : [];
  window._shiftsCached = data;
  openModal("Turnos", data, [
    { header:"ID", field:"id" },
    { header:"Nombre", field:"name" },
    { header:"Inicio", field:"start_time" },
    { header:"Fin", field:"end_time" },
  ], "shifts");
}
window.openSitesModal = openSitesModal;
window.openProjectsModal = openProjectsModal;
window.openShiftsModal = openShiftsModal;

// ===== Historial de régimen (definida en global) =====
window.openTaxHistoryModal = async function openTaxHistoryModal(){
  try{
    const data = await loadTaxHistory();
    openModal("Histórico de Régimen Tributario", data, [
      { header:"ID", field:"id" },
      { header:"Régimen", field:"name" },
      { header:"Desde", field:"valid_from" },
      { header:"Hasta", field:"valid_to" },
    ], "tax");
  }catch(e){
    showMsg('err',`Error cargando historial: ${e.message}`);
  }
};

// ===== Init DOM =====
window.addEventListener('DOMContentLoaded', async () => {
  // activar link activo
  document.querySelectorAll('.nav a').forEach(a=>{
    const href=a.getAttribute('href'); if(!href) return;
    if (location.pathname.endsWith(href)) {
      a.classList.add('active');
      a.setAttribute('aria-current','page');
    }
  });

  // botones
  const $ = (id)=>document.getElementById(id);
  $('btnEmpCargar')   && $('btnEmpCargar').addEventListener('click', ()=> loadEmployer().catch(e=>showMsg('err', e.message)));
  $('btnEmpGuardar')  && $('btnEmpGuardar').addEventListener('click', ()=> saveEmployer().catch(e=>showMsg('err', e.message)));
  $('btnTaxReload')   && $('btnTaxReload').addEventListener('click', ()=> Promise.resolve().then(loadTaxRegimes).then(loadCurrentTax).catch(e=>showMsg('err', e.message)));
  $('btnTaxSave')     && $('btnTaxSave').addEventListener('click', ()=> saveEmployerTax().catch(e=>showMsg('err', e.message)));
  $('btnTaxHistory')  && $('btnTaxHistory').addEventListener('click', ()=> window.openTaxHistoryModal());

  $('btnSiteAdd')     && $('btnSiteAdd').addEventListener('click', async ()=>{
    try{
      clearMsg();
      const name = $('siteName')?.value.trim();
      const res = await fetch(SITES, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
      if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
      if($('siteName')) $('siteName').value='';
      showMsg('ok','Sede creada.'); await reloadSites();
    }catch(e){ showMsg('err',`Error al crear sede: ${e.message}`); }
  });

  $('btnProjAdd')     && $('btnProjAdd').addEventListener('click', async ()=>{
    try{
      clearMsg();
      const name = $('projName')?.value.trim();
      if(!name) throw new Error("Completa el nombre del proyecto");
      const res = await fetch(PROJECTS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
      if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
      if($('projName')) $('projName').value='';
      showMsg('ok','Proyecto creado.'); await reloadProjects();
    }catch(e){ showMsg('err',`Error al crear proyecto: ${e.message}`); }
  });
  $('btnProjectsView')&& $('btnProjectsView').addEventListener('click', ()=> openProjectsModal());

  $('btnShiftAdd')    && $('btnShiftAdd').addEventListener('click', async ()=>{
    try{
      clearMsg();
      const name  = $('shiftName')?.value.trim();
      const start = $('shiftStart')?.value;
      const end   = $('shiftEnd')?.value;
      const res = await fetch(SHIFTS, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, start_time:start, end_time:end }) });
      if(!res.ok){ const t=await res.text(); throw new Error(`${res.status} ${t}`); }
      if($('shiftName')) $('shiftName').value='';
      showMsg('ok','Turno creado.'); await reloadShifts();
    }catch(e){ showMsg('err',`Error al crear turno: ${e.message}`); }
  });
  $('btnShiftsView')  && $('btnShiftsView').addEventListener('click', ()=> openShiftsModal());

  // init
  try{ await loadEmployer(); }catch{}
  try{
    const taxValidFrom = $('taxValidFrom');
    if(taxValidFrom) taxValidFrom.value = new Date().toISOString().slice(0,10);
    await loadTaxRegimes();
    await loadCurrentTax();
  }catch(e){ showMsg('err', e.message); }
  await reloadSites();
  await reloadProjects();
  await reloadShifts();
});
</script>
<script>
function closeMenu(){
  document.body.classList.remove('menu-open');
  document.getElementById('menuBtn').setAttribute('aria-expanded','false');
}
document.addEventListener('DOMContentLoaded',()=>{
  const btn=document.getElementById('menuBtn');
  const backdrop=document.getElementById('backdrop');
  btn?.addEventListener('click',()=>{
    const open=document.body.classList.toggle('menu-open');
    btn.setAttribute('aria-expanded',open);
  });
  backdrop?.addEventListener('click',closeMenu);
  document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeMenu(); });
});
</script>
</body>
</html>




