<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Usuario / Configuración</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="styles.css">
<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
<a class="skip-link" href="#main">Saltar al contenido</a>
<header class="topbar">
  <button id="menuBtn" class="menu-btn" aria-controls="sidebar" aria-expanded="false" aria-label="Menú">☰</button>
  <div class="logo-sm">RR.HH. Suite</div>
</header>

<aside id="sidebar" class="sidebar">
  <div class="logo">RR.HH. Suite</div>
  <nav class="nav" aria-label="Navegación principal">
    <div class="caption">Reclutamiento</div>
    <a href="formularioweb.html">Formulario</a>
    <a href="consulta.html">Consulta</a>
    <div class="caption">Operación</div>
    <a href="empleados.html">Empleados</a>
    <a href="contratos.html">Contratos</a>
    <a href="nomina.html">Nómina</a>
    <div class="sep"></div>
    <div class="caption">Usuario / Configuración</div>
    <a href="config.html" class="active">Parámetros de Empresa</a>
  </nav>
</aside>

<div id="backdrop" class="menu-backdrop" tabindex="-1"></div>

<main id="main" class="main" tabindex="-1">
  <div id="msg"></div>
  <div class="grid">

    <!-- EMPRESA -->
    <div class="card">
      <h2>Empresa</h2>
      <div class="row">
        <div><label>RUC</label><input id="empRuc" placeholder="20123456789"></div>
        <div><label>Razón Social</label><input id="empName" placeholder="Mi Empresa SAC"></div>
      </div>
      <label>Logo URL (opcional)</label>
      <input id="empLogo" placeholder="https://...">
      <div class="actions">
        <button id="btnEmpGuardar">Guardar/Actualizar</button>
        <button class="secondary" id="btnEmpCargar">Cargar existente</button>
      </div>
      <div class="small">Solo manejaremos 1 empresa activa (la principal).</div>
    </div>

    <!-- RÉGIMEN TRIBUTARIO -->
    <div class="card">
      <h2>Régimen Tributario</h2>
      <div class="row">
        <div>
          <label>Régimen</label>
          <select id="taxRegime"></select>
        </div>
        <div>
          <label>Vigente desde</label>
          <input id="taxValidFrom" type="date">
        </div>
      </div>
      <div class="actions">
        <button id="btnTaxSave">Guardar/Actualizar Régimen</button>
        <!-- Eliminado: botón Recargar -->
        <button class="secondary" id="btnTaxHistory">Ver historial</button>
      </div>
      <div class="small" id="taxCurrent"></div>
    </div>

    <!-- SEDES -->
    <div class="card">
      <h2>Sedes</h2>
      <div class="row">
        <div><label>Nombre de la Sede</label><input id="siteName" placeholder="Sede Lima"></div>
      </div>
      <div class="actions">
        <button id="btnSiteAdd">Agregar</button>
        <button class="secondary" onclick="openSitesModal()">Ver todo</button>
      </div>
    </div>

    <!-- PROYECTOS (sin sede) -->
    <div class="card">
      <h2>Proyectos</h2>
      <div class="row">
        <div><label>Nombre del Proyecto</label><input id="projName" placeholder="Proyecto General Lima"></div>
      </div>
      <div class="small">El código interno se genera automáticamente.</div>
      <div class="actions">
        <button id="btnProjAdd">Agregar</button>
        <button class="secondary" onclick="openProjectsModal()">Ver todo</button>
      </div>
    </div>

    <!-- TURNOS -->
    <div class="card">
      <h2>Turnos</h2>
      <div class="row3">
        <div><label>Nombre</label><input id="shiftName" placeholder="Mañana"></div>
        <div><label>Inicio</label><input id="shiftStart" type="time" value="08:00"></div>
        <div><label>Fin</label><input id="shiftEnd" type="time" value="17:00"></div>
      </div>
      <div class="actions">
        <button id="btnShiftAdd">Agregar</button>
        <button class="secondary" onclick="openShiftsModal()">Ver todo</button>
      </div>
    </div>

  </div>
</main>

<!-- MODAL reutilizable -->
<div id="modalWrap" class="modal-backdrop">
  <div class="modal">
    <header>
      <h3 id="modalTitle">Listado</h3>
      <div>
        <input id="modalSearch" type="search" placeholder="Buscar…">
        <button class="secondary" onclick="closeModal()">Cerrar</button>
      </div>
    </header>
    <div id="modalContent"></div>
    <div class="pager">
      <button class="secondary" id="modalPrev">« Prev</button>
      <span id="modalPageInfo" class="small"></span>
      <button class="secondary" id="modalNext">Next »</button>
    </div>
  </div>
</div>

<script>
// ===== Helpers UI =====
function showMsg(type, text){
  const box = document.getElementById('msg');
  if(!box) return;
  box.className = type === 'ok' ? 'ok' : 'err';
  box.textContent = text;
  box.style.display = 'block';
}
function clearMsg(){
  const box = document.getElementById('msg');
  if(!box) return;
  box.style.display = 'none';
  box.textContent = '';
  box.className = '';
}
// Mostrar errores JS arriba
window.addEventListener('error', (e)=>{ showMsg('err', `JS Error: ${e.message}`); });

// ===== CONFIG API =====
const API_BASE = "https://empleados-api-o6yy.onrender.com";
const EMP = `${API_BASE}/api/employer`;
const TAX_REGIMES = `${API_BASE}/api/regimes/tax`;
const EMP_TAX = `${API_BASE}/api/employer/tax`;
const EMP_TAX_HISTORY = `${API_BASE}/api/employer/tax/history`;
const SITES = `${API_BASE}/api/sites`;
const PROJECTS = `${API_BASE}/api/projects`;
const SHIFTS = `${API_BASE}/api/shifts`;

// ===== Data funcs =====
async function loadEmployer(){
  clearMsg();
  const res = await fetch(EMP);
  if(!res.ok) throw new Error(`${res.status}`);
  const data = await r






